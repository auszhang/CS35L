(function ($) {

    Drupal.behaviors.image_caption = {
        attach: function (context, settings) {
            $(".pane-node-body img:not(.caption-processed)").each(function (i) {
                //console.log(this);

                var self = $(this);

                var imgwidth = self.width() ? self.width() : false;
                var imgheight = self.height() ? self.height() : false;

                // Get caption from title attribute
                var captiontext;
                var title = self.attr('title');
                var alt = self.attr('alt');
                captiontext = (alt) ? alt : title;

                if (!captiontext || !captiontext.length || captiontext == "undefined") return;

                // Get image alignment and style to apply to container
                if (self.attr('align')) {
                    var alignment = self.attr('align');
                    self.css({'float': alignment}); // add to css float
                    self.removeAttr('align');
                } else if (self.css('float')) {
                    var alignment = self.css('float');
                } else {
                    var alignment = 'normal';
                }
                var style = self.attr('style') ? self.attr('style') : '';


                // Reset img styles as are added to container instead
                self.removeAttr('width');
                self.removeAttr('height');
                self.css('width', '');
                self.css('height', '');
                self.removeAttr('align');
                self.removeAttr('style');

                //Display inline block so it doesn't break any text aligns on the parent contatiner
                self.wrap("<figure class=\"image-caption-container\" style=\"display:inline-block;" + style + "\"></figure>");
                self.parent().addClass('image-caption-container-' + alignment).css('height', 'auto');

                // Add dimensions, if available
                if (imgwidth) {
                    self.width(imgwidth);
                    self.parent().width(imgwidth);
                }
                if (imgheight) {
                    self.height(imgheight);
                }
                // Append caption
                self.parent().append("<figcaption style=\"display:block;\" class=\"image-caption\">" + captiontext + "</figcaption>");

                // Add class to prevent duplicate caption adding
                self.addClass('caption-processed');
            });
        }
    };

})(jQuery);