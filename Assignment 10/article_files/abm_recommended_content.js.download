Drupal.behaviors.abm_recommended_content = {
    attach: function (context) {
        // Check to see if related content result exists
        if (Drupal.settings.abm_recommended_content.result) {
            var templateData = Drupal.settings.abm_recommended_content.result;
            console.log(templateData);

            var $ = window.jQuery;

            _.templateSettings.variable = "rc";

            var $templateDiv = $("script.lead-gen-template");
            if (!$templateDiv.length) return;
            // Grab the HTML out of our template tag and pre-compile it.

            var template = _.template($templateDiv.html());
            console.log($templateDiv.html());

            // Render the underscore template and inject it after the first <p>
            // in our current DOM.

            var $ps = $('p');
            //var pCount = $ps.length;
            var afterThis, booya;

            $ps.each(function(index) {

                if((this.textContent.length > 420) &&
                    //to avoid showing up inside an "Embedded Sidebar" Paragraphs element
                    (this.parentElement.localName != "blockquote")) {
                    console.log(index);
                    afterThis = index;
                    booya = true;
                    return false;
                }
            });

            if (booya) {
                $ps.eq(afterThis).before(
                    template(templateData)
                );
            }
            // TODO - place in sidebar if no good body location.
        }
    }
};
